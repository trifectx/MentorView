<div class="post-detail-container">
  <a routerLink="/forum" class="back-link">
    <i class="fa fa-arrow-left"></i> Back to Forum
  </a>

  <!-- Post Content -->
  <div *ngIf="post" class="post-card">
    <div class="vote-area" (click)="$event.stopPropagation()">
      <button class="upvote-btn" (click)="upvotePost()">
        <i class="fa fa-arrow-up"></i>
      </button>
      <span class="score">{{ post.score || 0 }}</span>
    </div>

    <div class="post-content">
      <h1 class="post-title">{{ post.title }}</h1>
      <p class="post-info">
        Posted by {{ post.userName }} • {{ formatDate(post.createdAt) | timeAgo }}
      </p>
      <div class="post-body">{{ post.content }}</div>
      
      <div class="post-actions">
        <button class="reply-btn" (click)="startReply()">
          <i class="fa fa-reply"></i> Reply
        </button>
        <button *ngIf="currentUser && post.userId === currentUser.uid" 
          class="delete-btn" (click)="deletePost()">
          <i class="fa fa-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Sort Controls -->
  <div class="sort-controls">
    <span>Sort by:</span>
    <button [class.active]="currentSort === sortOptions.Best" (click)="changeSortOption(sortOptions.Best)">
      Best
    </button>
    <button [class.active]="currentSort === sortOptions.Newest" (click)="changeSortOption(sortOptions.Newest)">
      New
    </button>
    <button [class.active]="currentSort === sortOptions.Oldest" (click)="changeSortOption(sortOptions.Oldest)">
      Old
    </button>
  </div>

  <!-- Reply Form -->
  <div id="reply-form" class="reply-form" *ngIf="currentUser">
    <h3 *ngIf="!replyingTo">Add a Reply</h3>
    <h3 *ngIf="replyingTo">Replying to {{ replyingToName }}</h3>
    <textarea 
      [(ngModel)]="newReply" 
      placeholder="What are your thoughts?"
      rows="4"
    ></textarea>
    <div class="form-actions">
      <button class="btn-cancel" *ngIf="replyingTo" (click)="cancelReply()">Cancel</button>
      <button class="btn-submit" (click)="submitReply()">Submit</button>
    </div>
  </div>

  <!-- Login prompt if not logged in -->
  <div *ngIf="!currentUser" class="login-prompt">
    <p>Please log in to reply to this post.</p>
  </div>

  <!-- Replies Section -->
  <div class="replies-section">
    <h2 *ngIf="(nestedReplies$ | async)?.length">Replies ({{ post?.replyCount || 0 }})</h2>
    <div *ngIf="(nestedReplies$ | async)?.length === 0" class="no-replies">
      <p>No replies yet. Be the first to reply!</p>
    </div>

    <!-- Recursively render nested replies -->
    <ng-container *ngFor="let reply of nestedReplies$ | async">
      <ng-container *ngTemplateOutlet="replyTemplate; context: { $implicit: reply, depth: 0 }"></ng-container>
    </ng-container>
  </div>

  <!-- Reply Template (used recursively for nested replies) -->
  <ng-template #replyTemplate let-reply let-depth="depth">
    <div class="reply-card" [ngClass]="'depth-' + depth">
      <div class="reply-connector"></div>
      
      <div class="vote-area" (click)="$event.stopPropagation()">
        <button class="upvote-btn" (click)="upvoteReply(reply.id!, $event)">
          <i class="fa fa-arrow-up"></i>
        </button>
        <span class="score">{{ reply.score || 0 }}</span>
      </div>

      <div class="reply-content">
        <p class="reply-info">
          {{ reply.userName }} • {{ formatDate(reply.createdAt) | timeAgo }}
        </p>
        <div class="reply-body">{{ reply.content }}</div>
        
        <div class="reply-actions">
          <button class="reply-btn" (click)="startReply(reply.id, reply.userName)">
            <i class="fa fa-reply"></i> Reply
          </button>
          <button *ngIf="currentUser && reply.userId === currentUser.uid" 
            class="delete-btn" (click)="deleteReply(reply.id!)">
            <i class="fa fa-trash"></i> Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Render child replies recursively -->
    <div class="nested-replies" *ngIf="reply.children && reply.children.length > 0">
      <ng-container *ngFor="let childReply of reply.children">
        <ng-container *ngTemplateOutlet="replyTemplate; context: { $implicit: childReply, depth: depth + 1 }"></ng-container>
      </ng-container>
    </div>
  </ng-template>
</div>
